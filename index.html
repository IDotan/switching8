<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <style>
        :root {
            --boxs-size: 8vh;
            --boxs-gap: 0.5vh;
            --jumpover-time: 0.75s;
            --animation-x-offset: 0;
            --animation-y-offset: 0;
            --animation-x-offset-counter: 0;
            --animation-y-offset-counter: 0;
        }

        body {
            background-color: gray;
        }

        #game_continer {
            display: flex;
            flex-direction: column;
            width: max-content;
            height: max-content;
            margin: auto;
        }

        .space {
            position: relative;
            width: var(--boxs-size);
            height: var(--boxs-size);
            margin: var(--boxs-gap);
            border: 0.1em solid black;
            box-sizing: border-box;
        }

        .red {
            background-color: red;
        }

        .blue {
            background-color: blue;
        }

        .switch {
            animation: switch_frames var(--jumpover-time) linear forwards;
        }

        @keyframes switch_frames {
            from {
                transform-origin: var(--animation-x-offset) var(--animation-y-offset);
            }

            to {
                transform-origin: var(--animation-x-offset) var(--animation-y-offset);
                rotate: 180deg;
            }
        }

        .switch_counter {
            animation: switch_counter_frames var(--jumpover-time) linear forwards;
        }

        @keyframes switch_counter_frames {
            from {
                transform-origin: var(--animation-x-offset-counter) var(--animation-y-offset-counter);
            }

            to {
                transform-origin: var(--animation-x-offset-counter) var(--animation-y-offset-counter);
                rotate: 180deg;
            }
        }

        @media screen and (min-aspect-ratio:1/1) {
            :root {
                --boxs-size: 9vw;
                --boxs-gap: 0.5vw;
            }

            #game_section {
                display: flex;
                height: calc(var(--boxs-size) * 3);
            }

            #game_continer {
                flex-direction: row;
            }
        }
    </style>
    <main>
        <section id="game_section">
            <div id="game_continer">
                <div class="space red"></div>
                <div class="space red"></div>
                <div class="space red"></div>
                <div class="space red"></div>
                <div class="space"></div>
                <div class="space blue"></div>
                <div class="space blue"></div>
                <div class="space blue"></div>
                <div class="space blue"></div>
            </div>
        </section>
    </main>
    <script>
        let animation_time = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--jumpover-time').replace('s', '')) * 1000;
        let in_move = false;

        function cube_switch(clicked, space, horizontal, double = null) {
            let clicked_rect = clicked.getBoundingClientRect();
            let width = clicked_rect['width'];
            let switch_rect = space.getBoundingClientRect();
            let pos_offset;
            let rotate_x = '--animation-y-offset';
            let rotate_y = '--animation-x-offset';
            let rotate_x_counter = '--animation-y-offset-counter';
            let rotate_y_counter = '--animation-x-offset-counter';
            if (horizontal) {
                pos_offset = (switch_rect['left'] - clicked_rect['right']) / 2;
            } else {
                pos_offset = (switch_rect['top'] - clicked_rect['bottom']) / 2;
                rotate_x = '--animation-x-offset';
                rotate_y = '--animation-y-offset';
                rotate_x_counter = '--animation-x-offset-counter';
                rotate_y_counter = '--animation-y-offset-counter';
            };

            document.documentElement.style.setProperty(rotate_x, (width / 2) + 'px');
            document.documentElement.style.setProperty(rotate_y, (pos_offset + width) + 'px');
            document.documentElement.style.setProperty(rotate_x_counter, (width / 2) + 'px');
            document.documentElement.style.setProperty(rotate_y_counter, ((pos_offset * (-1)) + 'px'));

            clicked.classList.add('switch');
            space.classList.add('switch_counter');

            setTimeout(() => {
                clicked.classList.remove('switch');
                space.classList.remove('switch_counter');
                if (!double) {
                    space.insertAdjacentElement('afterend', clicked);
                } else {
                    space.insertAdjacentElement('afterend', clicked);
                    space.insertAdjacentElement('afterend', double);
                };
                in_move = false;
            }, animation_time);
        };

        function cube_switch_setup(cube, direction) {
            if (in_move) { return };
            let clicked = cube;
            let next = cube.nextElementSibling;
            let next_next;
            if (next) { next_next = next.nextElementSibling };
            let horizontal = false;
            if (direction == 'beforebegin') {
                next = cube.previousElementSibling;
                next_next = next.previousElementSibling;
            };

            if (getComputedStyle(document.documentElement).getPropertyValue('--boxs-size').includes('vw')) {
                horizontal = true;
            }

            if (next.className == "space") {
                in_move = true;
                if (direction == 'afterend') {
                    cube_switch(clicked, next, horizontal);
                } else {
                    cube_switch(next, clicked, horizontal);
                };
            } else if (next_next.className == "space") {
                in_move = true;
                if (direction == 'afterend') {
                    cube_switch(clicked, next_next, horizontal, next);
                } else {
                    cube_switch(next_next, clicked, horizontal, next);
                };
            };
        }

        document.querySelectorAll('.red').forEach((div) => {
            div.addEventListener('click', () => {
                cube_switch_setup(event.target, 'afterend');
            });
        });

        document.querySelectorAll('.blue').forEach((div) => {
            div.addEventListener('click', () => {
                cube_switch_setup(event.target, 'beforebegin');
            });
        });

    </script>
</body>

</html>